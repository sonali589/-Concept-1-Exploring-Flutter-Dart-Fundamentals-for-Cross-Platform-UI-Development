// Firestore Security Rules for Production
// These rules should be applied in Firebase Console → Firestore Database → Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Tasks collection rules
    match /tasks/{taskId} {
      // Allow read if user is authenticated and owns the task
      allow read: if isSignedIn() && 
                     isOwner(resource.data.userId);
      
      // Allow create if user is authenticated and sets userId to their own ID
      allow create: if isSignedIn() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['title', 'userId', 'completed', 'createdAt']);
      
      // Allow update if user owns the task and doesn't change userId
      allow update: if isSignedIn() && 
                       isOwner(resource.data.userId) &&
                       request.resource.data.userId == resource.data.userId;
      
      // Allow delete if user owns the task
      allow delete: if isSignedIn() && 
                       isOwner(resource.data.userId);
    }
    
    // Users collection (if you add user profiles later)
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isOwner(userId);
    }
  }
}


// Firebase Storage Security Rules
// Apply in Firebase Console → Storage → Rules

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Profile pictures - only owner can upload/delete
    match /profile_pictures/{userId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Task attachments - only owner can upload/delete
    match /task_attachments/{userId}/{taskId}/{fileName} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // General uploads - authenticated users only
    match /uploads/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      request.resource.size < 10 * 1024 * 1024; // Max 10MB
    }
  }
}


// Important Notes for Production:

// 1. ALWAYS test security rules in Firebase Console's Rules Simulator
// 2. Never use test mode rules in production
// 3. Implement proper validation for all fields
// 4. Add file size limits to prevent abuse
// 5. Consider adding rate limiting for writes
// 6. Regularly audit security rules
// 7. Use Firebase Security Rules Unit Testing

// Testing Example:
// firebase emulators:start --only firestore
// npm install --save-dev @firebase/rules-unit-testing
